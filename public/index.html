<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Butterfly Breeding Management System</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card h4 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .batch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .batch-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .batch-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .batch-id {
            font-weight: bold;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .lifecycle-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .lifecycle-egg { background: #ffeaa7; color: #2d3436; }
        .lifecycle-larva { background: #74b9ff; color: white; }
        .lifecycle-pupa { background: #fd79a8; color: white; }
        .lifecycle-adult { background: #00b894; color: white; }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-healthy { background: #00b894; }
        .status-warning { background: #fdcb6e; }
        .status-critical { background: #e17055; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-success {
            background: #38a169;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #f0fff4;
            border-color: #38a169;
            color: #22543d;
        }

        .alert-warning {
            background: #fffbf0;
            border-color: #d69e2e;
            color: #744210;
        }

        .alert-danger {
            background: #fff5f5;
            border-color: #e53e3e;
            color: #742a2a;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* Achievement System Styles */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border-left: 5px solid;
        }

        .achievement-card:hover {
            transform: translateY(-3px);
        }

        .achievement-card.common { border-left-color: #9CA3AF; }
        .achievement-card.uncommon { border-left-color: #10B981; }
        .achievement-card.rare { border-left-color: #3B82F6; }
        .achievement-card.epic { border-left-color: #8B5CF6; }
        .achievement-card.legendary { border-left-color: #F59E0B; }

        .achievement-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-right: 15px;
            width: 50px;
            text-align: center;
        }

        .achievement-info h4 {
            margin: 0;
            color: #2D3748;
            font-size: 1.2rem;
        }

        .achievement-info p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .achievement-points {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: auto;
        }

        .achievement-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .achievement-stat {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .achievement-stat h3 {
            font-size: 2rem;
            margin: 0;
        }

        .achievement-stat p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #F7FAFC;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
            min-width: 40px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-info h4 {
            margin: 0;
            color: #2D3748;
        }

        .leaderboard-info p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 0.9rem;
        }

        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #718096;
        }

        .close:hover {
            color: #4a5568;
        }

        .qr-code {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code img {
            max-width: 200px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .batch-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            max-width: 300px;
            transform: translateX(350px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Butterfly Breeding Management System</h1>
            <p>Advanced CNN-powered breeding optimization with real-time monitoring</p>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <i class="fas fa-chart-dashboard"></i> Dashboard
            </button>
            <button class="nav-tab" onclick="showTab('batches')">
                <i class="fas fa-boxes"></i> Cage Management
            </button>
            <button class="nav-tab" onclick="showTab('classification')">
                <i class="fas fa-brain"></i> AI Classification
            </button>
            <button class="nav-tab" onclick="showTab('marketplace')">
                <i class="fas fa-shopping-cart"></i> Marketplace
            </button>
            <button class="nav-tab" onclick="showTab('tasks')">
                <i class="fas fa-tasks"></i> Task Management
            </button>
            <button class="nav-tab" onclick="showTab('achievements')">
                <i class="fas fa-trophy"></i> Achievements
            </button>
            <button class="nav-tab" onclick="showTab('analytics')">
                <i class="fas fa-chart-line"></i> Profit Analytics
            </button>
            <button class="nav-tab" onclick="showTab('breeding-log')">
                <i class="fas fa-clipboard-list"></i> Breeding Log
            </button>
            <button class="nav-tab" onclick="showTab('settings')">
                <i class="fas fa-cog"></i> Settings
            </button>
            <button class="nav-tab" onclick="showTab('student-dashboard')">
                <i class="fas fa-graduation-cap"></i> Student Dashboard
            </button>
            <button class="nav-tab" onclick="viewProfile()" style="margin-left: auto; background: #48bb78;">
                <i class="fas fa-user"></i> My Profile
            </button>
            <button class="nav-tab" onclick="logout()" style="background: #e53e3e;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>
            
            <div class="card">
                <h3><i class="fas fa-exclamation-triangle"></i> Active Alerts</h3>
                <div id="alerts-container">
                    <!-- Alerts will be populated by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-boxes"></i> Recent Batch Activity</h3>
                <div id="recent-activity">
                    <!-- Recent activity will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Cage Management Tab -->
        <div id="batches" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-plus"></i> Create New Cage Batch</h3>
                <form id="create-batch-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="species">Species *</label>
                            <select id="species" required>
                                <option value="">Select Species</option>
                                <!-- Species will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="larva-count">Total Count *</label>
                            <input type="number" id="larva-count" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="phone-number">Phone Number *</label>
                            <input type="tel" id="phone-number" placeholder="+1234567890" required>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea id="notes" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-plus"></i> Create Batch
                    </button>
                </form>
            </div>

            <div class="card">
                <h3><i class="fas fa-boxes"></i> Active Cage Batches</h3>
                <div class="batch-grid" id="batch-grid">
                    <!-- Batches will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- AI Classification Tab -->
        <div id="classification" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-brain"></i> CNN Image Classification</h3>
                <p>Upload images for AI-powered analysis of butterfly species, lifecycle stages, larval diseases, and pupae defects.</p>
                
                <div class="form-group">
                    <label for="analysis-type">Analysis Type</label>
                    <select id="analysis-type">
                        <option value="all">Complete Analysis (All Models)</option>
                        <option value="species">Species Identification</option>
                        <option value="stage">Lifecycle Stage</option>
                        <option value="disease">Larval Disease Detection</option>
                        <option value="defects">Pupae Defect Analysis</option>
                    </select>
                </div>
                
                <div class="image-upload" onclick="document.getElementById('classification-image').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #667eea; margin-bottom: 10px;"></i>
                    <p>Click to upload image or drag and drop</p>
                    <p style="font-size: 0.9rem; color: #718096;">Supported formats: JPG, PNG (max 10MB)</p>
                    <input type="file" id="classification-image" accept="image/*" style="display: none;">
                </div>
                
                <div id="classification-results" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-info-circle"></i> Model Information</h3>
                <div id="model-status">
                    <!-- Model status will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Marketplace Tab -->
        <div id="marketplace" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-shopping-cart"></i> Butterfly Marketplace</h3>
                <p>Buy and sell butterfly specimens from verified breeders with secure GCash payments.</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <label for="marketplace-filter">Filter by Species:</label>
                        <select id="marketplace-filter" onchange="filterMarketplace()">
                            <option value="">All Species</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <button onclick="loadMarketplace()" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> Refresh Listings
                    </button>
                </div>
                
                <div id="marketplace-grid" class="batch-grid">
                    <!-- Marketplace items will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-receipt"></i> My Orders</h3>
                <div style="margin-bottom: 20px;">
                    <button onclick="loadUserOrders('buyer')" class="btn btn-small">Purchase Orders</button>
                    <button onclick="loadUserOrders('seller')" class="btn btn-small">Sales Orders</button>
                </div>
                <div id="user-orders">
                    <!-- User orders will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-history"></i> Pupae Sales History</h3>
                <p style="color: #718096; margin-bottom: 20px;">View detailed transaction history for pupae sales with seller and purchaser profiles</p>
                <div style="margin-bottom: 20px;">
                    <button onclick="loadPupaeSalesHistory()" class="btn btn-secondary">
                        <i class="fas fa-refresh"></i> Load Sales History
                    </button>
                </div>
                <div id="pupae-sales-history">
                    <!-- Pupae sales history will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Task Management Tab -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-plus"></i> Create New Task</h3>
                <form id="create-task-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="task-title">Task Title *</label>
                            <input type="text" id="task-title" required>
                        </div>
                        <div class="form-group">
                            <label for="task-type">Task Type *</label>
                            <select id="task-type" required>
                                <option value="">Select Type</option>
                                <option value="feeding">Feeding</option>
                                <option value="pest_control">Pest Control</option>
                                <option value="cage_cleaning">Cage Cleaning</option>
                                <option value="health_check">Health Check</option>
                                <option value="plant_replacement">Plant Replacement</option>
                                <option value="temperature_check">Temperature Check</option>
                                <option value="humidity_check">Humidity Check</option>
                                <option value="breeding_record">Breeding Record</option>
                                <option value="quality_assessment">Quality Assessment</option>
                                <option value="harvest">Harvest</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-priority">Priority</label>
                            <select id="task-priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="task-due-date">Due Date</label>
                            <input type="datetime-local" id="task-due-date">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="task-description">Description</label>
                            <textarea id="task-description" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </form>
            </div>

            <div class="card">
                <h3><i class="fas fa-tasks"></i> Task List</h3>
                <div id="task-list">
                    <!-- Tasks will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Profit Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Profit Overview</h3>
                <div id="profit-overview">
                    <!-- Profit data will be populated by JavaScript -->
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> Species Performance</h3>
                <div id="species-performance">
                    <!-- Species data will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Breeding Log Tab -->
        <div id="breeding-log" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> Activity Log</h3>
                <div id="log-container">
                    <!-- Log entries will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-trophy"></i> Achievement Progress</h3>
                <div id="achievement-stats">
                    <!-- Achievement statistics will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-medal"></i> Earned Achievements</h3>
                <div id="earned-achievements">
                    <!-- Earned achievements will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-target"></i> Progress Towards Next Achievements</h3>
                <div id="progress-achievements">
                    <!-- Progress achievements will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-ranking-star"></i> Leaderboard</h3>
                <div id="leaderboard">
                    <!-- Leaderboard will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Student Dashboard Tab -->
        <div id="student-dashboard" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-graduation-cap"></i> Student Portal - Butterfly Production Training</h3>
                <p>Access your butterfly breeding training courses and certification programs through TESDA.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                    <!-- Course Enrollment -->
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                        <i class="fas fa-certificate" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>Butterfly Production Level II</h4>
                        <p style="margin: 15px 0;">Advanced breeding techniques and quality management certification program</p>
                        <div style="margin: 20px 0;">
                            <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 10px;">
                                <p><strong>Duration:</strong> 80 hours</p>
                                <p><strong>Type:</strong> Blended Learning</p>
                                <p><strong>Certificate:</strong> NC II</p>
                            </div>
                        </div>
                        <button onclick="showEnrollmentModal()" class="btn" style="background: white; color: #667eea; font-weight: bold; width: 100%;">
                            <i class="fas fa-user-plus"></i> ENROLL NOW
                        </button>
                    </div>
                    
                    <!-- Scholarship Information -->
                    <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                        <i class="fas fa-hand-holding-usd" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>TESDA Scholarship Program</h4>
                        <p style="margin: 15px 0;">Get free training with TESDA scholarship opportunities for qualified students</p>
                        <div style="margin: 20px 0;">
                            <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 10px;">
                                <p><strong>Coverage:</strong> 100% Training Fee</p>
                                <p><strong>Allowance:</strong> Available</p>
                                <p><strong>Requirements:</strong> Basic Education</p>
                            </div>
                        </div>
                        <button onclick="showScholarshipModal()" class="btn" style="background: white; color: #48bb78; font-weight: bold; width: 100%;">
                            <i class="fas fa-info-circle"></i> HOW TO APPLY
                        </button>
                    </div>
                    
                    <!-- Exploration Center -->
                    <div style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; border-radius: 15px; padding: 25px; text-align: center;">
                        <i class="fas fa-compass" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>Explore Career Paths</h4>
                        <p style="margin: 15px 0;">Discover various career opportunities in butterfly farming and biotechnology</p>
                        <div style="margin: 20px 0;">
                            <div style="background: rgba(255,255,255,0.2); border-radius: 8px; padding: 10px;">
                                <p><strong>Opportunities:</strong> Entrepreneur</p>
                                <p><strong>Industry:</strong> Agriculture</p>
                                <p><strong>Growth:</strong> High Demand</p>
                            </div>
                        </div>
                        <button onclick="showCareerModal()" class="btn" style="background: white; color: #ed8936; font-weight: bold; width: 100%;">
                            <i class="fas fa-search"></i> EXPLORE
                        </button>
                    </div>
                </div>
                
                <!-- Quick Access Links -->
                <div class="card" style="margin-top: 30px;">
                    <h4><i class="fas fa-external-link-alt"></i> Quick Access Links</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                        <a href="https://tesda.gov.ph" target="_blank" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                            <i class="fas fa-globe"></i> TESDA Official Website
                        </a>
                        <a href="https://enrollment.tesda.gov.ph" target="_blank" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                            <i class="fas fa-laptop"></i> Online Enrollment Portal
                        </a>
                        <a href="https://scholarship.tesda.gov.ph" target="_blank" class="btn btn-secondary" style="text-decoration: none; text-align: center;">
                            <i class="fas fa-graduation-cap"></i> Scholarship Portal
                        </a>
                        <button onclick="downloadTrainingGuide()" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Download Training Guide
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3><i class="fas fa-sms"></i> SMS Configuration</h3>
                <div id="twilio-status">
                    <div style="padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #38a169; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-check-circle" style="color: #38a169; margin-right: 10px;"></i>
                            <span style="font-weight: bold;">SMS Notifications Enabled</span>
                        </div>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #2d3748;">
                            Twilio SMS service is properly configured and ready to send notifications.
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="test-phone">Test Phone Number</label>
                    <input type="tel" id="test-phone" placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label for="test-message">Test Message</label>
                    <textarea id="test-message" rows="3"> Test message from Butterfly Breeding Management System!</textarea>
                </div>
                <button onclick="sendTestSMS()" class="btn">
                    <i class="fas fa-paper-plane"></i> Send Test SMS
                </button>
            </div>

            <!-- AR Lifecycle Viewer -->
            <div class="card">
                <h3><i class="fas fa-eye"></i> AR Lifecycle Viewer</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Experience butterfly lifecycle stages in augmented reality or 3D visualization.
                </p>
                
                <div id="ar-container" style="margin-bottom: 20px;">
                    <!-- AR viewer will be inserted here -->
                </div>
                
                <div id="stage-details" style="margin-top: 20px;">
                    <!-- Stage details will be shown here -->
                </div>
                
                <div class="form-group">
                    <label for="ar-species">Select Species for AR View</label>
                    <select id="ar-species" onchange="updateARSpecies()">
                        <option value="">Choose species...</option>
                    </select>
                </div>
                
                <button onclick="initializeAR()" class="btn btn-secondary">
                    <i class="fas fa-cube"></i> Initialize AR Viewer
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-database"></i> Data Management</h3>
                <button onclick="exportData()" class="btn">
                    <i class="fas fa-download"></i> Export Data
                </button>
                <button onclick="checkFeedingSchedule()" class="btn btn-secondary">
                    <i class="fas fa-clock"></i> Check Feeding Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBatchModal()">&times;</span>
            <h3 id="modal-title">Batch Details</h3>
            <div id="modal-content">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchase-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePurchaseModal()">&times;</span>
            <h3>Purchase Butterfly Batch</h3>
            <div id="purchase-content">
                <!-- Purchase form will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePaymentModal()">&times;</span>
            <h3>Complete Payment</h3>
            <div id="payment-content">
                <!-- Payment details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- List for Sale Modal -->
    <div id="sale-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSaleModal()">&times;</span>
            <h3>List Batch for Sale</h3>
            <div id="sale-content">
                <form id="list-for-sale-form">
                    <div class="form-group">
                        <label for="sale-price">Price (PHP) *</label>
                        <input type="number" id="sale-price" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="sale-description">Description</label>
                        <textarea id="sale-description" rows="3" placeholder="Describe the quality and characteristics of your butterflies..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="sale-location">Your Location</label>
                        <input type="text" id="sale-location" placeholder="City, Province">
                    </div>
                    <div class="form-group">
                        <label for="sale-available-date">Available Date</label>
                        <input type="date" id="sale-available-date">
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-tag"></i> List for Sale
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification" class="notification">
        <div id="notification-content"></div>
    </div>

    <script>
        // Global variables
        let socket;
        let batches = [];
        let breedingLog = [];
        let currentBatch = null;
        let currentUser = null;
        let authToken = null;
        let tasks = [];
        let speciesData = [];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        // Check authentication status
        async function checkAuthentication() {
            authToken = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            
            if (!authToken || !userData) {
                // Auto-login with default admin credentials for convenience
                try {
                    const loginResponse = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123'
                        })
                    });
                    
                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        localStorage.setItem('auth_token', loginData.token);
                        localStorage.setItem('user_data', JSON.stringify(loginData.user));
                        authToken = loginData.token;
                        currentUser = loginData.user;
                        updateUserInterface();
                        initializeSocket();
                        loadInitialData();
                        setupEventListeners();
                        return;
                    }
                } catch (error) {
                    console.error('Auto-login failed:', error);
                }
                
                // Redirect to login page if auto-login fails
                window.location.href = '/login.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(userData);
                updateUserInterface();
                initializeSocket();
                loadInitialData();
                setupEventListeners();
            } catch (error) {
                console.error('Error parsing user data:', error);
                logout();
            }
        }

        // Update UI based on user role
        function updateUserInterface() {
            const header = document.querySelector('.header h1');
            header.textContent = ` Welcome, ${currentUser.firstName} ${currentUser.lastName}`;
            
            const subtitle = document.querySelector('.header p');
            subtitle.textContent = `Role: ${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} | Advanced CNN-powered breeding optimization`;
            
            // Hide tabs based on user permissions
            hideTabsBasedOnRole();
        }

        // Hide tabs based on user role permissions
        function hideTabsBasedOnRole() {
            const permissions = getRolePermissions(currentUser.role);
            
            // Classification tab
            if (!permissions.includes('classify_images') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'classification\')"]').style.display = 'none';
            }
            
            // Task management tab
            if (!permissions.includes('manage_tasks') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'tasks\')"]').style.display = 'none';
            }
            
            // Analytics tab
            if (!permissions.includes('view_analytics') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'analytics\')"]').style.display = 'none';
            }
        }

        // Get role permissions
        function getRolePermissions(role) {
            const rolePermissions = {
                admin: ['*'],
                breeder: ['view_batches', 'create_batches', 'update_batches', 'view_analytics', 'manage_tasks', 'classify_images'],
                enthusiast: ['view_batches', 'create_batches', 'classify_images'],
                purchaser: ['view_batches', 'view_analytics'],
                student: ['view_batches', 'classify_images'],
                faculty: ['view_batches', 'create_batches', 'view_analytics', 'classify_images'],
                other: ['view_batches']
            };
            return rolePermissions[role] || ['view_batches'];
        }

        // View profile function
        function viewProfile(userId = null) {
            const profileUrl = userId ? `/profile.html?userId=${userId}` : '/profile.html';
            window.open(profileUrl, '_blank');
        }

        // Logout function
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            window.location.href = '/login.html';
        }

        // Make authenticated API calls
        async function makeAuthenticatedRequest(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            const response = await fetch(url, {
                ...options,
                headers
            });
            
            if (response.status === 401 || response.status === 403) {
                // Token expired or invalid
                logout();
                return null;
            }
            
            return response;
        }

        // Socket.IO initialization
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                showNotification('Connected to server', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                showNotification('Disconnected from server', 'warning');
            });
            
            socket.on('batchCreated', function(batch) {
                showNotification(`New batch created: ${batch.species}`, 'success');
                loadBatches();
            });
            
            socket.on('batchUpdated', function(batch) {
                showNotification(`Batch updated: ${batch.cageId.substring(0, 8)}`, 'info');
                loadBatches();
            });
            
            socket.on('batchFed', function(batch) {
                showNotification(`Batch fed: ${batch.species}`, 'success');
                loadBatches();
            });
            
            socket.on('feedingAlert', function(data) {
                showNotification(`Feeding alert: ${data.species}`, 'warning');
            });
            
            socket.on('overdueAlert', function(data) {
                showNotification(`OVERDUE: ${data.species} (${data.overdueHours.toFixed(1)}h)`, 'danger');
            });
            
            socket.on('activityLog', function(entry) {
                loadBreedingLog();
            });
            
            socket.on('achievementUnlocked', function(data) {
                showAchievementNotification(data.achievements);
                if (currentTab === 'achievements') {
                    loadAchievements();
                }
            });
        }

        // Load initial data
        async function loadInitialData() {
            await loadSpeciesData();
            await loadBatches();
            await loadBreedingLog();
            await loadAnalytics();
            await loadTasks();
            await loadModelStatus();
            await loadMarketplace();
            updateDashboard();
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('create-batch-form').addEventListener('submit', createBatch);
            document.getElementById('create-task-form').addEventListener('submit', createTask);
            document.getElementById('classification-image').addEventListener('change', handleImageUpload);
            document.getElementById('list-for-sale-form').addEventListener('submit', listBatchForSale);
        }

        // Load species data
        async function loadSpeciesData() {
            try {
                const response = await makeAuthenticatedRequest('/api/species');
                if (response) {
                    speciesData = await response.json();
                    populateSpeciesDropdown();
                }
            } catch (error) {
                console.error('Error loading species data:', error);
            }
        }

        // Populate species dropdown
        function populateSpeciesDropdown() {
            const speciesSelect = document.getElementById('species');
            if (!speciesSelect) {
                console.error('Species select element not found');
                return;
            }
            
            speciesSelect.innerHTML = '<option value="">Select Species</option>';
            
            if (speciesData && speciesData.length > 0) {
                speciesData.forEach(species => {
                    const option = document.createElement('option');
                    option.value = species.name;
                    option.textContent = `${species.name} - $${species.marketPrice}`;
                    speciesSelect.appendChild(option);
                });
                console.log('Species dropdown populated with', speciesData.length, 'species');
            } else {
                console.log('No species data available');
            }
        }

        // Load batches from API
        async function loadBatches() {
            try {
                const response = await makeAuthenticatedRequest('/api/batches');
                if (response) {
                    batches = await response.json();
                    updateBatchGrid();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                showNotification('Error loading batches', 'danger');
            }
        }

        // Load tasks
        async function loadTasks() {
            try {
                const response = await makeAuthenticatedRequest('/api/tasks');
                if (response) {
                    tasks = await response.json();
                    updateTaskList();
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Load model status
        async function loadModelStatus() {
            try {
                const response = await makeAuthenticatedRequest('/api/cnn/status');
                if (response) {
                    const status = await response.json();
                    updateModelStatus(status);
                }
            } catch (error) {
                console.error('Error loading model status:', error);
            }
        }

        // Load breeding log from API
        async function loadBreedingLog() {
            try {
                const response = await makeAuthenticatedRequest('/api/breeding-log');
                if (response) {
                    breedingLog = await response.json();
                    updateBreedingLog();
                }
            } catch (error) {
                console.error('Error loading breeding log:', error);
                showNotification('Error loading breeding log', 'danger');
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const response = await makeAuthenticatedRequest('/api/analytics/profit');
                if (response) {
                    const analytics = await response.json();
                    updateAnalytics(analytics);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showNotification('Error loading analytics', 'danger');
            }
        }

        // Create new batch
        async function createBatch(event) {
            event.preventDefault();
            
            const speciesValue = document.getElementById('species').value;
            const larvaCountValue = document.getElementById('larva-count').value;
            const phoneNumberValue = document.getElementById('phone-number').value;
            const notesValue = document.getElementById('notes').value;
            
            // Validate form data
            if (!speciesValue) {
                showNotification('Please select a species', 'warning');
                return;
            }
            
            if (!larvaCountValue || parseInt(larvaCountValue) <= 0) {
                showNotification('Please enter a valid larva count', 'warning');
                return;
            }
            
            if (!phoneNumberValue) {
                showNotification('Please enter a phone number', 'warning');
                return;
            }
            
            const formData = {
                species: speciesValue,
                larvaCount: parseInt(larvaCountValue),
                phoneNumber: phoneNumberValue,
                notes: notesValue || ''
            };
            
            console.log('Submitting batch data:', formData);
            
            try {
                const response = await makeAuthenticatedRequest('/api/batches', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response && response.ok) {
                    const batch = await response.json();
                    showNotification('Batch created successfully!', 'success');
                    document.getElementById('create-batch-form').reset();
                    loadBatches();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Error creating batch', 'danger');
                    console.error('Server error:', error);
                } else {
                    showNotification('Network error - please try again', 'danger');
                }
            } catch (error) {
                console.error('Error creating batch:', error);
                showNotification('Error creating batch: ' + error.message, 'danger');
            }
        }

        // Create new task
        async function createTask(event) {
            event.preventDefault();
            
            const formData = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                type: document.getElementById('task-type').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value
            };
            
            try {
                const response = await makeAuthenticatedRequest('/api/tasks', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response && response.ok) {
                    const task = await response.json();
                    showNotification('Task created successfully!', 'success');
                    document.getElementById('create-task-form').reset();
                    loadTasks();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Error creating task', 'danger');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                showNotification('Error creating task', 'danger');
            }
        }

        // Handle image upload for CNN classification
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification('File size too large. Maximum 10MB allowed.', 'danger');
                return;
            }
            
            const analysisType = document.getElementById('analysis-type').value;
            const formData = new FormData();
            formData.append('image', file);
            formData.append('analysisType', analysisType);
            
            try {
                showNotification('Analyzing image...', 'info');
                
                const response = await fetch('/api/cnn/classify', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayClassificationResults(data.results);
                    showNotification('Image analysis completed!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Classification failed', 'danger');
                }
            } catch (error) {
                console.error('Error classifying image:', error);
                showNotification('Network error during classification', 'danger');
            }
        }

        // Display CNN classification results
        function displayClassificationResults(results) {
            const container = document.getElementById('classification-results');
            container.style.display = 'block';
            
            let html = '<h4>Analysis Results</h4>';
            
            if (results.species) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h5><i class="fas fa-butterfly"></i> Species Classification</h5>
                        <div style="display: grid; gap: 10px;">
                            ${results.species.predictions.slice(0, 3).map((pred, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: ${index === 0 ? '#f0fff4' : '#f7fafc'}; border-radius: 4px;">
                                    <span><strong>${pred.species}</strong></span>
                                    <span>${(pred.confidence * 100).toFixed(1)}%</span>
                                    <span style="color: #38a169;">$${pred.marketPrice}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (results.stage) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h5><i class="fas fa-circle-notch"></i> Lifecycle Stage</h5>
                        <div style="display: grid; gap: 10px;">
                            ${results.stage.predictions.map((pred, index) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: ${index === 0 ? '#f0fff4' : '#f7fafc'}; border-radius: 4px;">
                                    <span><strong>${pred.stage}</strong></span>
                                    <span>${(pred.confidence * 100).toFixed(1)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (results.disease) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h5><i class="fas fa-virus"></i> Disease Detection</h5>
                        <div style="display: grid; gap: 10px;">
                            ${results.disease.predictions.slice(0, 3).map((pred, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: ${pred.disease === 'Healthy' ? '#f0fff4' : '#fff5f5'}; border-radius: 4px;">
                                    <span><strong>${pred.disease}</strong></span>
                                    <span>${(pred.confidence * 100).toFixed(1)}%</span>
                                    <span style="color: ${pred.disease === 'Healthy'? '#38a169' : '#e53e3e'};">Impact: ${(pred.profitImpact * 100).toFixed(0)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (results.defects) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h5><i class="fas fa-search"></i> Quality Assessment</h5>
                        <div style="display: grid; gap: 10px;">
                            ${results.defects.predictions.slice(0, 3).map((pred, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: ${pred.defect === 'Healthy' ? '#f0fff4' : '#fff5f5'}; border-radius: 4px;">
                                    <span><strong>${pred.defect}</strong></span>
                                    <span>${(pred.confidence * 100).toFixed(1)}%</span>
                                    <span style="color: ${pred.defect === 'Healthy' ? '#38a169' : '#e53e3e'};">Grade: ${pred.qualityGrade}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (results.summary) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; border: 2px solid #667eea; border-radius: 8px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));">
                        <h5><i class="fas fa-chart-line"></i> Overall Assessment</h5>
                        <p><strong>Health Score:</strong> ${(results.summary.overallHealthScore * 100).toFixed(1)}%</p>
                        <p><strong>Quality Grade:</strong> ${results.summary.qualityGrade}</p>
                        
                        ${results.summary.recommendedActions.length > 0 ? `
                            <h6>Recommended Actions:</h6>
                            <ul>
                                ${results.summary.recommendedActions.map(action => `
                                    <li style="color: ${action.priority === 'high' ? '#e53e3e' : action.priority === 'medium' ? '#d69e2e' : '#38a169'};">
                                        <strong>${action.action}:</strong> ${action.description}
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Update model status display
        function updateModelStatus(status) {
            const container = document.getElementById('model-status');
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Initialization Status</h6>
                        <p style="color: ${status.initialized ? '#38a169' : '#e53e3e'};">
                            ${status.initialized ? ' Initialized' : ' Not Initialized'}
                        </p>
                    </div>
                    
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Species Model</h6>
                        <p style="color: ${status.models.butterfly_species_names ? '#38a169' : '#e53e3e'};">
                            ${status.models.butterfly_species_names ? ' Ready' : ' Not Available'}
                        </p>
                    </div>
                    
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Lifecycle Model</h6>
                        <p style="color: ${status.models.lifestages_names ? '#38a169' : '#e53e3e'};">
                            ${status.models.lifestages_names ? ' Ready' : ' Not Available'}
                        </p>
                    </div>
                    
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Disease Model</h6>
                        <p style="color: ${status.models.larvaldiseases_names ? '#38a169' : '#e53e3e'};">
                            ${status.models.larvaldiseases_names ? ' Ready' : ' Not Available'}
                        </p>
                    </div>
                    
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Defects Model</h6>
                        <p style="color: ${status.models.pupaedefects_names ? '#38a169' : '#e53e3e'};">
                            ${status.models.pupaedefects_names ? ' Ready' : ' Not Available'}
                        </p>
                    </div>
                    
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h6>Supported Species (18)</h6>
                        <p style="color: #4a5568;">${status.supportedSpecies} species</p>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px; font-size: 0.9rem; color: #4a5568;">
                    <strong>Note:</strong> The CNN models are currently using 18 butterfly species, 6 pupae defects, 4 larval disease, and 4 stages.
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Update task list
        function updateTaskList() {
            const container = document.getElementById('task-list');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p>No tasks assigned. Create a new task to get started.</p>';
                return;
            }
            
            const sortedTasks = tasks.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                const statusOrder = { pending: 3, 'in-progress': 2, completed: 1 };
                
                if (a.status !== b.status) {
                    return statusOrder[b.status] - statusOrder[a.status];
                }
                
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            container.innerHTML = sortedTasks.map(task => {
                const priorityColor = {
                    high: '#e53e3e',
                    medium: '#d69e2e',
                    low: '#38a169'
                };
                
                const statusColor = {
                    pending: '#d69e2e',
                    'in-progress': '#3182ce',
                    completed: '#38a169'
                };
                
                return `
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; ${task.status === 'completed' ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h6 style="margin: 0;">${task.title}</h6>
                            <div>
                                <span style="background: ${priorityColor[task.priority]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px;">
                                    ${task.priority.toUpperCase()}
                                </span>
                                <span style="background: ${statusColor[task.status]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                                    ${task.status.replace('-', ' ').toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        <p style="margin: 5px 0; color: #4a5568;">${task.description || 'No description'}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: #718096;">
                            <span>Type: ${task.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            <span>Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
                        </div>
                        
                        ${task.status !== 'completed' ? `
                            <div style="margin-top: 10px;">
                                <button onclick="updateTaskStatus('${task.id}', 'in-progress')" class="btn btn-small" style="margin-right: 5px;">
                                    Start
                                </button>
                                <button onclick="updateTaskStatus('${task.id}', 'completed')" class="btn btn-success btn-small">
                                    Complete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update task status
        async function updateTaskStatus(taskId, status) {
            try {
                const response = await makeAuthenticatedRequest(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                
                if (response && response.ok) {
                    showNotification('Task updated successfully!', 'success');
                    loadTasks();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Error updating task', 'danger');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Error updating task', 'danger');
            }
        }

        // Mark batch as fed
        async function markBatchFed(cageId) {
            try {
                const response = await fetch(`/api/batches/${cageId}/fed`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification('Batch marked as fed!', 'success');
                    loadBatches();
                    closeBatchModal();
                } else {
                    showNotification('Error marking batch as fed', 'danger');
                }
            } catch (error) {
                console.error('Error marking batch as fed:', error);
                showNotification('Error marking batch as fed', 'danger');
            }
        }

        // Update batch lifecycle stage
        async function updateLifecycleStage(cageId, stage) {
            if (!stage) return;
            
            try {
                const response = await fetch(`/api/batches/${cageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lifecycleStage: stage })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Lifecycle updated to ${stage} - Automatic actions applied`, 'success');
                    loadBatches();
                    loadBreedingLog(); // Refresh log to show new activities
                    closeBatchModal();
                } else {
                    showNotification('Error updating lifecycle stage', 'danger');
                }
            } catch (error) {
                console.error('Error updating lifecycle stage:', error);
                showNotification('Error updating lifecycle stage', 'danger');
            }
        }

        // Show batch details modal
        function showBatchDetails(cageId) {
            const batch = batches.find(b => b.cageId === cageId);
            if (!batch) return;
            
            currentBatch = batch;
            
            const modal = document.getElementById('batch-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            
            title.textContent = `${batch.species} - ${batch.cageId.substring(0, 8)}`;
            
            const profitData = batch.profitProjection;
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Batch Information</h4>
                        <p><strong>Species:</strong> ${batch.species}</p>
                        <p><strong>Larva Count:</strong> ${batch.larvaCount}</p>
                        <p><strong>Lifecycle Stage:</strong> 
                            <span class="lifecycle-badge lifecycle-${batch.lifecycleStage.toLowerCase()}">${batch.lifecycleStage}</span>
                        </p>
                        <p><strong>Host Plant:</strong> ${batch.hostPlant}</p>
                        <p><strong>Survival Rate:</strong> ${(batch.survivalRate * 100).toFixed(1)}%</p>
                        <p><strong>Quality Score:</strong> ${(batch.qualityScore * 100).toFixed(1)}%</p>
                        <p><strong>Foliage Level:</strong> ${batch.foliageLevel}%</p>
                        ${batch.status ? `<p><strong>Status:</strong> <span style="color: #38a169; font-weight: bold;">${batch.status.toUpperCase()}</span></p>` : ''}
                        
                        ${batch.lifecycleHistory && batch.lifecycleHistory.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h5>Lifecycle Progress:</h5>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 5px; padding: 10px;">
                                    ${batch.lifecycleHistory.slice(-3).map(history => `
                                        <div style="font-size: 0.9rem; margin: 5px 0; padding: 5px; background: #f7fafc; border-radius: 3px;">
                                            <strong>${history.previousStage}  ${history.stage}</strong><br>
                                            <span style="color: #38a169;">Action: ${history.automaticAction}</span><br>
                                            <span style="color: #718096; font-size: 0.8rem;">${new Date(history.date).toLocaleDateString()}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label>Lifecycle Management:</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <p><strong>Current Stage:</strong> 
                                    <span class="lifecycle-badge lifecycle-${batch.lifecycleStage.toLowerCase()}">${batch.lifecycleStage}</span>
                                </p>
                                
                                <div style="margin-top: 15px;">
                                    <h5>Stage-Specific Actions:</h5>
                                    ${getStageSpecificActions(batch)}
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <label>Transition to Next Stage:</label>
                                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                                        ${getTransitionButtons(batch)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4>Profit Projection</h4>
                        <p><strong>Projected Revenue:</strong> $${profitData.revenue.toFixed(2)}</p>
                        <p><strong>Production Cost:</strong> $${profitData.productionCost.toFixed(2)}</p>
                        <p><strong>Projected Profit:</strong> $${profitData.profit.toFixed(2)}</p>
                        <p><strong>Expected Count:</strong> ${profitData.qualityAdjustedCount.toFixed(0)}</p>
                        
                        <h4 style="margin-top: 20px;">Feeding Schedule</h4>
                        <p><strong>Last Fed:</strong> ${new Date(batch.lastFeeding).toLocaleString()}</p>
                        <p><strong>Next Feeding:</strong> ${new Date(batch.nextFeeding).toLocaleString()}</p>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="markBatchFed('${batch.cageId}')" class="btn btn-success btn-small">
                                <i class="fas fa-utensils"></i> Mark as Fed
                            </button>
                            ${batch.forSale ? `
                                <button onclick="removeBatchFromSale('${batch.cageId}')" class="btn btn-danger btn-small">
                                    <i class="fas fa-times"></i> Remove from Sale
                                </button>
                            ` : `
                                <button onclick="showListForSaleModal('${batch.cageId}')" class="btn btn-secondary btn-small">
                                    <i class="fas fa-tag"></i> List for Sale
                                </button>
                            `}
                        </div>
                    </div>
                </div>
                
                ${batch.qrCode ? `
                    <div class="qr-code">
                        <h4>QR Code</h4>
                        <img src="${batch.qrCode}" alt="Batch QR Code">
                    </div>
                ` : ''}
                
                <div style="margin-top: 20px;">
                    <h4>Notes</h4>
                    <p>${batch.notes || 'No notes available'}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Close batch modal
        function closeBatchModal() {
            document.getElementById('batch-modal').style.display = 'none';
            currentBatch = null;
        }

        // Update batch grid
        function updateBatchGrid() {
            const grid = document.getElementById('batch-grid');
            
            if (batches.length === 0) {
                grid.innerHTML = '<p>No active batches. Create your first batch to get started!</p>';
                return;
            }
            
            grid.innerHTML = batches.filter(batch => batch.active).map(batch => {
                const nextFeeding = new Date(batch.nextFeeding);
                const now = new Date();
                const timeUntilFeeding = nextFeeding - now;
                const hoursUntilFeeding = timeUntilFeeding / (1000 * 60 * 60);
                
                let statusClass = 'status-healthy';
                let statusText = 'On Schedule';
                
                if (hoursUntilFeeding <= 0) {
                    statusClass = 'status-critical';
                    statusText = 'OVERDUE';
                } else if (hoursUntilFeeding <= 2) {
                    statusClass = 'status-warning';
                    statusText = 'Due Soon';
                }
                
                const profitData = batch.profitProjection;
                
                return `
                    <div class="batch-card" onclick="showBatchDetails('${batch.cageId}')">
                        <div class="batch-header">
                            <div class="batch-id">${batch.cageId.substring(0, 8)}</div>
                            <span class="lifecycle-badge lifecycle-${batch.lifecycleStage.toLowerCase()}">${batch.lifecycleStage}</span>
                        </div>
                        
                        <h4>${batch.species}</h4>
                        <p><i class="fas fa-bug"></i> ${batch.larvaCount} larvae</p>
                        <p><i class="fas fa-leaf"></i> ${batch.hostPlant}</p>
                        
                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Foliage Level</span>
                                <span>${batch.foliageLevel}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${batch.foliageLevel}%"></div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Quality Score</span>
                                <span>${(batch.qualityScore * 100).toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${batch.qualityScore * 100}%"></div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <span class="status-indicator ${statusClass}"></span>
                            <span>${statusText}</span>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span>Projected Profit:</span>
                                <span style="font-weight: bold; color: ${profitData.profit >= 0 ? '#38a169' : '#e53e3e'};">
                                    $${profitData.profit.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update dashboard
        function updateDashboard() {
            updateStats();
            updateAlerts();
            updateRecentActivity();
        }

        // Update statistics
        function updateStats() {
            const activeBatches = batches.filter(batch => batch.active);
            const totalProfit = activeBatches.reduce((sum, batch) => sum + (batch.profitProjection?.profit || 0), 0);
            const averageQuality = activeBatches.length > 0 ? 
                activeBatches.reduce((sum, batch) => sum + batch.qualityScore, 0) / activeBatches.length : 0;
            
            const overdueCount = activeBatches.filter(batch => {
                const nextFeeding = new Date(batch.nextFeeding);
                return nextFeeding < new Date();
            }).length;
            
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h4>${activeBatches.length}</h4>
                    <p>Active Batches</p>
                </div>
                <div class="stat-card">
                    <h4>$${totalProfit.toFixed(0)}</h4>
                    <p>Projected Profit</p>
                </div>
                <div class="stat-card">
                    <h4>${(averageQuality * 100).toFixed(1)}%</h4>
                    <p>Average Quality</p>
                </div>
                <div class="stat-card">
                    <h4 style="color: ${overdueCount > 0 ? '#e53e3e' : '#38a169'}">${overdueCount}</h4>
                    <p>Overdue Feedings</p>
                </div>
            `;
        }

        // Update alerts
        function updateAlerts() {
            const activeBatches = batches.filter(batch => batch.active);
            const now = new Date();
            const alerts = [];
            
            activeBatches.forEach(batch => {
                const nextFeeding = new Date(batch.nextFeeding);
                const timeUntilFeeding = nextFeeding - now;
                const hoursUntilFeeding = timeUntilFeeding / (1000 * 60 * 60);
                
                if (hoursUntilFeeding <= 0) {
                    alerts.push({
                        type: 'danger',
                        message: `OVERDUE: ${batch.species} (${batch.cageId.substring(0, 8)}) - ${Math.abs(hoursUntilFeeding).toFixed(1)}h overdue`,
                        batch: batch
                    });
                } else if (hoursUntilFeeding <= 2) {
                    alerts.push({
                        type: 'warning',
                        message: `DUE SOON: ${batch.species} (${batch.cageId.substring(0, 8)}) - ${hoursUntilFeeding.toFixed(1)}h remaining`,
                        batch: batch
                    });
                }
                
                if (batch.foliageLevel < 20) {
                    alerts.push({
                        type: 'warning',
                        message: `LOW FOLIAGE: ${batch.species} (${batch.cageId.substring(0, 8)}) - ${batch.foliageLevel}% remaining`,
                        batch: batch
                    });
                }
                
                if (batch.qualityScore < 0.7) {
                    alerts.push({
                        type: 'warning',
                        message: `QUALITY CONCERN: ${batch.species} (${batch.cageId.substring(0, 8)}) - ${(batch.qualityScore * 100).toFixed(1)}% quality`,
                        batch: batch
                    });
                }
            });
            
            const alertsContainer = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="alert alert-success">All batches are healthy and on schedule!</div>';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        ${alert.message}
                        <button onclick="showBatchDetails('${alert.batch.cageId}')" class="btn btn-small" style="float: right; margin-top: -5px;">
                            View Details
                        </button>
                    </div>
                `).join('');
            }
        }

        // Update recent activity
        function updateRecentActivity() {
            const recentLog = breedingLog.slice(-10).reverse();
            const recentActivity = document.getElementById('recent-activity');
            
            if (recentLog.length === 0) {
                recentActivity.innerHTML = '<p>No recent activity</p>';
                return;
            }
            
            recentActivity.innerHTML = recentLog.map(entry => `
                <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>${entry.cageId ? entry.cageId.substring(0, 8) : 'System'}</strong>
                        <span style="color: #718096; font-size: 0.9rem;">${new Date(entry.timestamp).toLocaleString()}</span>
                    </div>
                    <p style="margin: 5px 0; color: #4a5568;">${entry.activity}</p>
                    ${entry.lifecycleStage ? `<span class="lifecycle-badge lifecycle-${entry.lifecycleStage.toLowerCase()}">${entry.lifecycleStage}</span>` : ''}
                </div>
            `).join('');
        }

        // Update breeding log
        function updateBreedingLog() {
            const logContainer = document.getElementById('log-container');
            
            if (breedingLog.length === 0) {
                logContainer.innerHTML = '<p>No breeding activities recorded yet.</p>';
                return;
            }
            
            // Sort by most recent first
            const sortedLog = [...breedingLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            logContainer.innerHTML = `
                <div style="max-height: 600px; overflow-y: auto;">
                    ${sortedLog.map(entry => `
                        <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; border-left: 3px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${entry.cageId ? entry.cageId.substring(0, 8) : 'System'}</strong>
                                    ${entry.lifecycleStage ? `<span class="lifecycle-badge lifecycle-${entry.lifecycleStage.toLowerCase()}">${entry.lifecycleStage}</span>` : ''}
                                </div>
                                <span style="color: #718096; font-size: 0.9rem;">
                                    ${new Date(entry.timestamp).toLocaleDateString()} 
                                    ${new Date(entry.timestamp).toLocaleTimeString()}
                                </span>
                            </div>
                            <p style="margin: 8px 0; color: #4a5568;">${entry.activity}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update analytics
        function updateAnalytics(analytics) {
            const profitOverview = document.getElementById('profit-overview');
            const speciesPerformance = document.getElementById('species-performance');
            
            // Profit overview
            profitOverview.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>$${analytics.summary.totalRevenue.toFixed(0)}</h4>
                        <p>Total Revenue</p>
                    </div>
                    <div class="stat-card">
                        <h4>$${analytics.summary.totalCosts.toFixed(0)}</h4>
                        <p>Total Costs</p>
                    </div>
                    <div class="stat-card">
                        <h4 style="color: ${analytics.summary.totalProfit >= 0 ? '#38a169' : '#e53e3e'}">
                            $${analytics.summary.totalProfit.toFixed(0)}
                        </h4>
                        <p>Net Profit</p>
                    </div>
                    <div class="stat-card">
                        <h4>${analytics.summary.averageMargin.toFixed(1)}%</h4>
                        <p>Profit Margin</p>
                    </div>
                </div>
            `;
            
            // Species performance
            const speciesData = Object.entries(analytics.speciesBreakdown);
            
            if (speciesData.length === 0) {
                speciesPerformance.innerHTML = '<p>No species data available</p>';
                return;
            }
            
            speciesPerformance.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    ${speciesData.map(([species, data]) => `
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0;">
                            <h4>${species}</h4>
                            <p><strong>Active Batches:</strong> ${data.count}</p>
                            <p><strong>Revenue:</strong> $${data.revenue.toFixed(2)}</p>
                            <p><strong>Profit:</strong> $${data.profit.toFixed(2)}</p>
                            <p><strong>Average Quality:</strong> ${(data.averageQuality * 100).toFixed(1)}%</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(tab => 
                tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)
            );
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Load data for specific tabs
            if (tabName === 'batches') {
                loadBatches();
                loadSpeciesData();
            } else if (tabName === 'marketplace') {
                loadMarketplace();
            } else if (tabName === 'tasks') {
                loadTasks();
            } else if (tabName === 'achievements') {
                loadAchievements();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            } else if (tabName === 'breeding-log') {
                loadBreedingLog();
            }
        }

        // Send test SMS
        async function sendTestSMS() {
            const phoneNumber = document.getElementById('test-phone').value;
            const message = document.getElementById('test-message').value;
            
            if (!phoneNumber || !message) {
                showNotification('Please enter both phone number and message', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/test-sms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber, message })
                });
                
                if (response.ok) {
                    showNotification('Test SMS sent successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send SMS', 'danger');
                }
            } catch (error) {
                console.error('Error sending test SMS:', error);
                showNotification('Error sending test SMS', 'danger');
            }
        }

        // Export data
        function exportData() {
            const data = {
                batches: batches,
                breedingLog: breedingLog,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `butterfly-breeding-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showNotification('Data exported successfully!', 'success');
        }

        // Check feeding schedule manually
        function checkFeedingSchedule() {
            socket.emit('checkFeeding');
            showNotification('Checking feeding schedule...', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notification-content');
            
            const icons = {
                success: 'fas fa-check-circle',
                warning: 'fas fa-exclamation-triangle',
                danger: 'fas fa-times-circle',
                info: 'fas fa-info-circle'
            };
            
            const colors = {
                success: '#38a169',
                warning: '#d69e2e',
                danger: '#e53e3e',
                info: '#3182ce'
            };
            
            content.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="${icons[type]}" style="color: ${colors[type]}; margin-right: 10px;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Marketplace Functions

        // Load marketplace items
        async function loadMarketplace() {
            try {
                const response = await makeAuthenticatedRequest('/api/marketplace');
                if (response) {
                    marketplaceItems = await response.json();
                    updateMarketplaceGrid();
                    populateMarketplaceFilter();
                }
            } catch (error) {
                console.error('Error loading marketplace:', error);
            }
        }

        // Update marketplace grid
        function updateMarketplaceGrid(filteredItems = null) {
            const grid = document.getElementById('marketplace-grid');
            const items = filteredItems || marketplaceItems || [];
            
            if (items.length === 0) {
                grid.innerHTML = '<p>No items available for purchase at the moment.</p>';
                return;
            }
            
            grid.innerHTML = items.map(item => `
                <div class="batch-card" style="cursor: pointer;">
                    <div class="batch-header">
                        <div class="batch-id">${item.species}</div>
                        <span class="lifecycle-badge lifecycle-${item.lifecycleStage.toLowerCase()}">${item.lifecycleStage}</span>
                    </div>
                    
                    <h4>${item.price.toFixed(2)} <span style="font-size: 0.8rem; color: #718096;">(${item.pricePerItem.toFixed(2)} each)</span></h4>
                    <p><i class="fas fa-bug"></i> ${item.larvaCount} specimens</p>
                    <p><i class="fas fa-leaf"></i> ${item.hostPlant}</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${item.sellerInfo.location}</p>
                    
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Quality Score</span>
                            <span>${(item.qualityScore * 100).toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${item.qualityScore * 100}%"></div>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span><strong>Seller:</strong> ${item.sellerInfo.sellerName}</span>
                            <button onclick="viewProfile('${item.sellerInfo.sellerId}')" class="btn btn-small" style="background: #e2e8f0; color: #4a5568; padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fas fa-user"></i> View Profile
                            </button>
                        </div>
                        <div style="font-size: 0.85rem; color: #718096; margin-bottom: 5px;">
                            @${item.sellerInfo.sellerUsername}  ${item.sellerInfo.sellerRole}
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.85rem;">Rating:</span>
                            <div>
                                ${Array.from({length: 5}, (_, i) => 
                                    `<i class="fas fa-star" style="color: ${i < item.sellerInfo.rating ? '#ffd700' : '#e2e8f0'};"></i>`
                                ).join('')}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #718096;">
                            Total Sales: ${item.sellerInfo.totalSales}  Listed: ${new Date(item.listedAt).toLocaleDateString()} ${new Date(item.listedAt).toLocaleTimeString()}
                        </div>
                    </div>
                    
                    ${item.salesHistory && item.salesHistory.length > 0 ? `
                        <div style="margin: 15px 0; padding: 10px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #38a169;">
                            <div style="font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; color: #2d3748;">
                                <i class="fas fa-history"></i> Recent Sales History
                            </div>
                            ${item.salesHistory.slice(-2).map(sale => `
                                <div style="padding: 5px 0; border-bottom: 1px solid #cbd5e0; font-size: 0.8rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span><strong>${sale.purchaserName}</strong> (@${sale.purchaserUsername})</span>
                                        <span style="color: #718096;">${sale.salePrice.toFixed(2)}</span>
                                    </div>
                                    <div style="color: #718096; font-size: 0.75rem; margin-top: 2px;">
                                        ${new Date(sale.purchaseDate).toLocaleDateString()} at ${new Date(sale.purchaseDate).toLocaleTimeString()}  ${sale.paymentMethod}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px;">
                        <button onclick="showPurchaseModal('${item.batchId}')" class="btn btn-success btn-small" style="width: 100%;">
                            <i class="fas fa-shopping-cart"></i> Purchase
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Populate marketplace filter dropdown
        function populateMarketplaceFilter() {
            const filter = document.getElementById('marketplace-filter');
            const species = [...new Set((marketplaceItems || []).map(item => item.species))];
            
            filter.innerHTML = '<option value="">All Species</option>' + 
                species.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        // Filter marketplace items
        function filterMarketplace() {
            const filter = document.getElementById('marketplace-filter').value;
            const filteredItems = filter ? 
                marketplaceItems.filter(item => item.species === filter) : 
                marketplaceItems;
            updateMarketplaceGrid(filteredItems);
        }

        // Show purchase modal
        function showPurchaseModal(batchId) {
            const item = marketplaceItems.find(i => i.batchId === batchId);
            if (!item) return;
            
            const modal = document.getElementById('purchase-modal');
            const content = document.getElementById('purchase-content');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>${item.species}</h4>
                    <p><strong>Quantity:</strong> ${item.larvaCount} specimens</p>
                    <p><strong>Price:</strong> ${item.price.toFixed(2)}</p>
                    <p><strong>Quality Score:</strong> ${(item.qualityScore * 100).toFixed(1)}%</p>
                    <p><strong>Seller:</strong> ${item.sellerInfo.location}</p>
                </div>
                
                <form id="purchase-form">
                    <div class="form-group">
                        <label for="purchase-quantity">Quantity to Purchase *</label>
                        <input type="number" id="purchase-quantity" min="1" max="${item.larvaCount}" value="1" required>
                        <small>Price per item: ${item.pricePerItem.toFixed(2)}</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="shipping-address">Shipping Address *</label>
                        <textarea id="shipping-address" rows="3" required placeholder="Complete address for delivery"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchase-notes">Notes (Optional)</label>
                        <textarea id="purchase-notes" rows="2" placeholder="Special instructions or comments"></textarea>
                    </div>
                    
                    <div style="padding: 15px; background: #f7fafc; border-radius: 8px; margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Subtotal:</span>
                            <span id="purchase-subtotal">${item.pricePerItem.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 10px;">
                            <span>Total:</span>
                            <span id="purchase-total">${item.pricePerItem.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <button type="button" onclick="processPurchase('${batchId}')" class="btn">
                        <i class="fas fa-credit-card"></i> Proceed to Payment
                    </button>
                </form>
            `;
            
            // Update totals when quantity changes
            document.getElementById('purchase-quantity').addEventListener('input', function() {
                const quantity = parseInt(this.value) || 1;
                const subtotal = quantity * item.pricePerItem;
                document.getElementById('purchase-subtotal').textContent = `${subtotal.toFixed(2)}`;
                document.getElementById('purchase-total').textContent = `${subtotal.toFixed(2)}`;
            });
            
            modal.style.display = 'block';
        }

        // Process purchase
        async function processPurchase(batchId) {
            const quantity = parseInt(document.getElementById('purchase-quantity').value);
            const shippingAddress = document.getElementById('shipping-address').value;
            const notes = document.getElementById('purchase-notes').value;
            
            if (!quantity || !shippingAddress) {
                showNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const item = marketplaceItems.find(i => i.batchId === batchId);
            const totalPrice = quantity * item.pricePerItem;
            
            try {
                showNotification('Creating order...', 'info');
                
                const orderData = {
                    items: [{
                        batchId: batchId,
                        quantity: quantity,
                        price: item.pricePerItem
                    }],
                    shippingAddress: shippingAddress,
                    notes: notes
                };
                
                const response = await makeAuthenticatedRequest('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
                
                if (response && response.ok) {
                    const order = await response.json();
                    closePurchaseModal();
                    showPaymentModal(order);
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to create order', 'danger');
                }
            } catch (error) {
                console.error('Error creating order:', error);
                showNotification('Error creating order', 'danger');
            }
        }

        // Show payment modal with GCash option
        function showPaymentModal(order) {
            const modal = document.getElementById('payment-modal');
            const content = document.getElementById('payment-content');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Order: ${order.orderId}</h4>
                    <p><strong>Total Amount:</strong> ${order.totalAmount.toFixed(2)}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h5>Payment Method</h5>
                    <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-mobile-alt" style="font-size: 2rem; color: #667eea; margin-right: 15px;"></i>
                            <div>
                                <h6>GCash Payment</h6>
                                <p style="margin: 0; color: #718096;">Secure and convenient mobile payment</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer-name">Full Name *</label>
                            <input type="text" id="customer-name" value="${currentUser.firstName} ${currentUser.lastName}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer-email">Email *</label>
                            <input type="email" id="customer-email" value="${currentUser.email}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="customer-phone">Phone Number *</label>
                            <input type="tel" id="customer-phone" placeholder="+63 9XX XXX XXXX" required>
                        </div>
                        
                        <button type="button" onclick="payWithGCash('${order.orderId}')" class="btn" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-credit-card"></i> Pay with GCash
                        </button>
                    </div>
                </div>
                
                <div style="font-size: 0.9rem; color: #718096; text-align: center;">
                    <p> Your payment is secured with industry-standard encryption</p>
                    <p>You will be redirected to GCash to complete the payment</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Pay with GCash
        async function payWithGCash(orderId) {
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            
            if (!customerName || !customerEmail || !customerPhone) {
                showNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            try {
                showNotification('Initializing GCash payment...', 'info');
                
                const paymentData = {
                    orderId: orderId,
                    customerName: customerName,
                    customerEmail: customerEmail,
                    customerPhone: customerPhone
                };
                
                const response = await makeAuthenticatedRequest('/api/payments/gcash', {
                    method: 'POST',
                    body: JSON.stringify(paymentData)
                });
                
                if (response && response.ok) {
                    const payment = await response.json();
                    
                    if (payment.paymentURL) {
                        closePaymentModal();
                        showNotification('Redirecting to GCash...', 'success');
                        
                        // In a real implementation, redirect to GCash
                        // For demo, simulate payment completion
                        setTimeout(() => {
                            simulatePaymentCompletion(payment.paymentId);
                        }, 3000);
                        
                        // window.open(payment.paymentURL, '_blank');
                    } else {
                        showNotification('Failed to create payment URL', 'danger');
                    }
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Payment initialization failed', 'danger');
                }
            } catch (error) {
                console.error('Error creating GCash payment:', error);
                showNotification('Payment initialization failed', 'danger');
            }
        }

        // Simulate payment completion for demo
        function simulatePaymentCompletion(paymentId) {
            showNotification('Payment completed successfully!', 'success');
            loadUserOrders('buyer');
            loadMarketplace(); // Refresh marketplace
        }

        // Load user orders
        async function loadUserOrders(role = 'buyer') {
            try {
                const response = await makeAuthenticatedRequest(`/api/orders?role=${role}`);
                if (response) {
                    const orders = await response.json();
                    updateUserOrders(orders, role);
                }
            } catch (error) {
                console.error('Error loading user orders:', error);
            }
        }

        // Update user orders display
        function updateUserOrders(orders, role) {
            const container = document.getElementById('user-orders');
            
            if (orders.length === 0) {
                container.innerHTML = `<p>No ${role === 'buyer' ? 'purchase' : 'sales'} orders found.</p>`;
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const statusColor = {
                    pending: '#d69e2e',
                    completed: '#38a169',
                    cancelled: '#e53e3e'
                };
                
                return `
                    <div style="padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h6>Order ${order.orderId}</h6>
                            <span style="background: ${statusColor[order.status]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
                                ${order.status.toUpperCase()}
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <p><strong>Total:</strong> ${order.totalAmount.toFixed(2)}</p>
                            <p><strong>Items:</strong> ${order.items.length} item(s)</p>
                            <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}</p>
                        </div>
                        
                        <div style="font-size: 0.9rem; color: #718096;">
                            ${order.items.map(item => `
                                <div> ${item.species} (${item.quantity}x) - ${item.totalPrice.toFixed(2)}</div>
                            `).join('')}
                        </div>
                        
                        ${role === 'buyer' && order.status === 'pending' ? `
                            <button onclick="cancelOrder('${order.orderId}')" class="btn btn-danger btn-small" style="margin-top: 10px;">
                                Cancel Order
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // List batch for sale
        async function listBatchForSale(event) {
            event.preventDefault();
            
            if (!currentBatch) return;
            
            const formData = {
                price: parseFloat(document.getElementById('sale-price').value),
                description: document.getElementById('sale-description').value,
                sellerLocation: document.getElementById('sale-location').value,
                availableDate: document.getElementById('sale-available-date').value
            };
            
            try {
                const response = await makeAuthenticatedRequest(`/api/batches/${currentBatch.cageId}/list-for-sale`, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (response && response.ok) {
                    showNotification('Batch listed for sale successfully!', 'success');
                    closeSaleModal();
                    loadBatches();
                    loadMarketplace();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to list batch', 'danger');
                }
            } catch (error) {
                console.error('Error listing batch for sale:', error);
                showNotification('Error listing batch for sale', 'danger');
            }
        }

        // Modal functions
        function closePurchaseModal() {
            document.getElementById('purchase-modal').style.display = 'none';
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }

        function closeSaleModal() {
            document.getElementById('sale-modal').style.display = 'none';
            currentBatch = null;
        }

        function showListForSaleModal(cageId) {
            const batch = batches.find(b => b.cageId === cageId);
            if (!batch) return;
            
            currentBatch = batch;
            
            // Pre-populate form with suggested values
            const suggestedPrice = batch.profitProjection?.revenue || 0;
            document.getElementById('sale-price').value = suggestedPrice.toFixed(2);
            document.getElementById('sale-available-date').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('sale-modal').style.display = 'block';
        }

        // Remove batch from sale
        async function removeBatchFromSale(cageId) {
            try {
                const response = await makeAuthenticatedRequest(`/api/batches/${cageId}/remove-from-sale`, {
                    method: 'POST'
                });
                
                if (response && response.ok) {
                    showNotification('Batch removed from sale successfully!', 'success');
                    loadBatches();
                    loadMarketplace();
                    closeBatchModal();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to remove batch from sale', 'danger');
                }
            } catch (error) {
                console.error('Error removing batch from sale:', error);
                showNotification('Error removing batch from sale', 'danger');
            }
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            loadBatches();
            loadBreedingLog();
            loadAnalytics();
            loadMarketplace();
        }, 30000);

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['batch-modal', 'purchase-modal', 'payment-modal', 'sale-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        // Achievement System Functions
        let currentTab = 'dashboard';
        let userAchievements = null;

        // Load achievements data
        async function loadAchievements() {
            try {
                const response = await makeAuthenticatedRequest(`/api/achievements/user/${currentUser.id}`);
                if (response && response.ok) {
                    userAchievements = await response.json();
                    updateAchievementDisplay();
                    loadLeaderboard();
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
                showNotification('Error loading achievements', 'danger');
            }
        }

        // Update achievement display
        function updateAchievementDisplay() {
            if (!userAchievements) return;

            // Update achievement stats
            const statsContainer = document.getElementById('achievement-stats');
            statsContainer.innerHTML = `
                <div class="achievement-stats">
                    <div class="achievement-stat">
                        <h3>${userAchievements.level}</h3>
                        <p>Level</p>
                    </div>
                    <div class="achievement-stat">
                        <h3>${userAchievements.totalPoints}</h3>
                        <p>Total Points</p>
                    </div>
                    <div class="achievement-stat">
                        <h3>${userAchievements.earnedAchievements.length}</h3>
                        <p>Achievements</p>
                    </div>
                    <div class="achievement-stat">
                        <h3>${userAchievements.nextLevelPoints}</h3>
                        <p>Next Level</p>
                    </div>
                </div>
            `;

            // Update earned achievements
            const earnedContainer = document.getElementById('earned-achievements');
            if (userAchievements.earnedAchievements.length === 0) {
                earnedContainer.innerHTML = '<p>No achievements earned yet. Start breeding to unlock your first achievement!</p>';
            } else {
                earnedContainer.innerHTML = `
                    <div class="achievement-grid">
                        ${userAchievements.earnedAchievements.map(achievement => `
                            <div class="achievement-card ${achievement.rarity}">
                                <div class="achievement-header">
                                    <div class="achievement-icon">${achievement.icon}</div>
                                    <div class="achievement-info">
                                        <h4>${achievement.name}</h4>
                                        <p>${achievement.description}</p>
                                    </div>
                                    <div class="achievement-points">+${achievement.points}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Update progress achievements
            const progressContainer = document.getElementById('progress-achievements');
            if (userAchievements.progress.length === 0) {
                progressContainer.innerHTML = '<p>All available achievements earned! Check back for new achievements.</p>';
            } else {
                progressContainer.innerHTML = `
                    <div class="achievement-grid">
                        ${userAchievements.progress.slice(0, 6).map(progress => `
                            <div class="achievement-card ${progress.achievement.rarity}">
                                <div class="achievement-header">
                                    <div class="achievement-icon">${progress.achievement.icon}</div>
                                    <div class="achievement-info">
                                        <h4>${progress.achievement.name}</h4>
                                        <p>${progress.achievement.description}</p>
                                    </div>
                                    <div class="achievement-points">+${progress.achievement.points}</div>
                                </div>
                                <div class="achievement-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                                    </div>
                                    <div class="achievement-progress-text">
                                        ${progress.currentValue} / ${progress.requiredValue} (${progress.percentage.toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await makeAuthenticatedRequest('/api/achievements/leaderboard?limit=10');
                if (response && response.ok) {
                    const leaderboard = await response.json();
                    updateLeaderboard(leaderboard);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Update leaderboard display
        function updateLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboard');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<p>No leaderboard data available yet.</p>';
                return;
            }

            container.innerHTML = leaderboard.map((user, index) => `
                <div class="leaderboard-entry">
                    <div class="leaderboard-rank">#${index + 1}</div>
                    <div class="leaderboard-info">
                        <h4>User ${user.userId}</h4>
                        <p>Level ${user.level}  ${user.achievementCount} achievements</p>
                    </div>
                    <div class="leaderboard-stats">
                        <strong>${user.totalPoints}</strong> points
                    </div>
                </div>
            `).join('');
        }

        // Show achievement notification
        function showAchievementNotification(achievements) {
            achievements.forEach((achievement, index) => {
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'achievement-notification';
                    notification.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <div style="font-size: 2rem; margin-right: 15px;">${achievement.icon}</div>
                            <div>
                                <h4 style="margin: 0; color: white;">Achievement Unlocked!</h4>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">${achievement.name}</p>
                                <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">+${achievement.points} points</p>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                }, index * 500); // Stagger multiple notifications
            });
        }

        // Load pupae sales history
        async function loadPupaeSalesHistory() {
            try {
                const response = await makeAuthenticatedRequest('/api/marketplace/pupae-sales');
                if (response && response.ok) {
                    const pupaeSales = await response.json();
                    updatePupaeSalesDisplay(pupaeSales);
                }
            } catch (error) {
                console.error('Error loading pupae sales history:', error);
                showNotification('Error loading pupae sales history', 'danger');
            }
        }

        // Update pupae sales display
        function updatePupaeSalesDisplay(pupaeSales) {
            const container = document.getElementById('pupae-sales-history');
            
            if (pupaeSales.length === 0) {
                container.innerHTML = '<p>No pupae sales history available yet.</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>Total Pupae Sales: ${pupaeSales.length}</h4>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    ${pupaeSales.map(sale => `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #2d3748;">${sale.species} Pupae</h4>
                                <span style="background: #e8f5e8; color: #38a169; padding: 4px 8px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
                                    SOLD
                                </span>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>Batch ID:</strong> ${sale.batchId.substring(0, 8)}</p>
                                <p style="margin: 5px 0;"><strong>Count:</strong> ${sale.larvaCount} specimens</p>
                                <p style="margin: 5px 0;"><strong>Quality:</strong> ${(sale.qualityScore * 100).toFixed(1)}%</p>
                                <p style="margin: 5px 0;"><strong>Host Plant:</strong> ${sale.hostPlant}</p>
                                <p style="margin: 5px 0;"><strong>Final Price:</strong> ${sale.finalSalePrice.toFixed(2)}</p>
                                <p style="margin: 5px 0;"><strong>Sale Date:</strong> ${new Date(sale.soldAt).toLocaleDateString()} at ${new Date(sale.soldAt).toLocaleTimeString()}</p>
                            </div>
                            
                            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: bold; color: #2d3748;">Seller Profile:</span>
                                    <button onclick="viewProfile('${sale.sellerInfo.id}')" class="btn btn-small" style="background: #e2e8f0; color: #4a5568; padding: 4px 8px; font-size: 0.8rem;">
                                        <i class="fas fa-user"></i> View Profile
                                    </button>
                                </div>
                                <p style="margin: 3px 0; font-size: 0.9rem;">${sale.sellerInfo.name}</p>
                                <p style="margin: 3px 0; font-size: 0.85rem; color: #718096;">@${sale.sellerInfo.username}  ${sale.sellerInfo.role}</p>
                            </div>
                            
                            ${sale.salesHistory.length > 0 ? `
                                <div style="padding: 10px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #38a169;">
                                    <h5 style="margin: 0 0 10px 0; color: #2d3748;">Purchase History:</h5>
                                    ${sale.salesHistory.map(purchase => `
                                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 5px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                <span style="font-weight: bold;">Purchaser: ${purchase.purchaserName}</span>
                                                <button onclick="viewProfile('${purchase.purchaserId}')" class="btn btn-small" style="background: #d1ecf1; color: #0c5460; padding: 2px 6px; font-size: 0.75rem;">
                                                    <i class="fas fa-user"></i> Profile
                                                </button>
                                            </div>
                                            <p style="margin: 3px 0; font-size: 0.85rem; color: #718096;">@${purchase.purchaserUsername}  ${purchase.purchaserRole}</p>
                                            <p style="margin: 3px 0; font-size: 0.85rem;"><strong>Price:</strong> ${purchase.salePrice.toFixed(2)}</p>
                                            <p style="margin: 3px 0; font-size: 0.85rem;"><strong>Date:</strong> ${new Date(purchase.purchaseDate).toLocaleDateString()} at ${new Date(purchase.purchaseDate).toLocaleTimeString()}</p>
                                            <p style="margin: 3px 0; font-size: 0.85rem;"><strong>Payment:</strong> ${purchase.paymentMethod}</p>
                                            <p style="margin: 3px 0; font-size: 0.8rem; color: #718096;"><strong>Order ID:</strong> ${purchase.orderId}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Stage-specific actions for improved cage management
        function getStageSpecificActions(batch) {
            const stage = batch.lifecycleStage;
            
            switch(stage) {
                case 'Egg':
                    return `
                        <div style="margin: 10px 0;">
                            <button onclick="performStageAction('${batch.cageId}', 'MARK_AS_HATCHED')" class="btn btn-success btn-small">
                                <i class="fas fa-egg"></i> Mark as Hatched
                            </button>
                            <p style="font-size: 0.9rem; color: #718096; margin-top: 5px;">
                                Records hatching and starts feeding schedule
                            </p>
                        </div>
                    `;
                case 'Larva':
                    return `
                        <div style="margin: 10px 0;">
                            <button onclick="performStageAction('${batch.cageId}', 'MARK_AS_FED')" class="btn btn-primary btn-small">
                                <i class="fas fa-utensils"></i> Mark as Fed
                            </button>
                            <p style="font-size: 0.9rem; color: #718096; margin-top: 5px;">
                                Records feeding and updates next feeding schedule
                            </p>
                        </div>
                    `;
                case 'Pupa':
                    return `
                        <div style="margin: 10px 0;">
                            <button onclick="performStageAction('${batch.cageId}', 'MARK_AS_HARVESTED')" class="btn btn-warning btn-small">
                                <i class="fas fa-harvest"></i> Mark as Harvested
                            </button>
                            <p style="font-size: 0.9rem; color: #718096; margin-top: 5px;">
                                Records pupae harvest and quality assessment
                            </p>
                        </div>
                    `;
                case 'Butterfly':
                    return `
                        <div style="margin: 10px 0;">
                            <button onclick="performStageAction('${batch.cageId}', 'MARK_AS_FORAGE')" class="btn btn-info btn-small">
                                <i class="fas fa-leaf"></i> Mark as Forage
                            </button>
                            <p style="font-size: 0.9rem; color: #718096; margin-top: 5px;">
                                Records foraging activity and nectar feeding
                            </p>
                        </div>
                    `;
                default:
                    return '<p>No specific actions available for this stage.</p>';
            }
        }

        function getTransitionButtons(batch) {
            const stage = batch.lifecycleStage;
            const transitions = {
                'Egg': 'Larva',
                'Larva': 'Pupa', 
                'Pupa': 'Butterfly',
                'Butterfly': null
            };
            
            const nextStage = transitions[stage];
            
            if (!nextStage) {
                return '<p style="color: #718096; font-size: 0.9rem;">Final stage reached</p>';
            }
            
            return `
                <button onclick="transitionLifecycleStage('${batch.cageId}', '${nextStage}')" class="btn btn-secondary btn-small">
                    <i class="fas fa-arrow-right"></i> Transition to ${nextStage}
                </button>
            `;
        }

        // Perform stage-specific action
        async function performStageAction(cageId, action) {
            try {
                const response = await makeAuthenticatedRequest(`/api/batches/${cageId}/stage-action`, {
                    method: 'POST',
                    body: JSON.stringify({ action })
                });
                
                if (response && response.ok) {
                    const result = await response.json();
                    showNotification(result.message || 'Action completed successfully', 'success');
                    loadBatches();
                    loadBreedingLog();
                    closeBatchModal();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Error performing action', 'danger');
                }
            } catch (error) {
                console.error('Error performing stage action:', error);
                showNotification('Error performing stage action', 'danger');
            }
        }

        // Transition lifecycle stage
        async function transitionLifecycleStage(cageId, newStage) {
            try {
                const response = await makeAuthenticatedRequest(`/api/batches/${cageId}/transition`, {
                    method: 'POST',
                    body: JSON.stringify({ newStage })
                });
                
                if (response && response.ok) {
                    const result = await response.json();
                    showNotification(`Transitioned to ${newStage} - ${result.message}`, 'success');
                    loadBatches();
                    loadBreedingLog();
                    closeBatchModal();
                } else if (response) {
                    const error = await response.json();
                    showNotification(error.error || 'Error transitioning stage', 'danger');
                }
            } catch (error) {
                console.error('Error transitioning lifecycle stage:', error);
                showNotification('Error transitioning lifecycle stage', 'danger');
            }
        }

        // Student Dashboard Functions
        function showEnrollmentModal() {
            showNotification('Redirecting to TESDA enrollment system...', 'info');
            setTimeout(() => {
                window.open('https://enrollment.tesda.gov.ph', '_blank');
            }, 1000);
        }

        function showScholarshipModal() {
            showNotification('Opening TESDA scholarship information...', 'info');
            setTimeout(() => {
                window.open('https://scholarship.tesda.gov.ph', '_blank');
            }, 1000);
        }

        function showCareerModal() {
            showNotification('Loading career exploration resources...', 'info');
            setTimeout(() => {
                alert(` Butterfly Farming Career Opportunities:

1. BUTTERFLY BREEDER ENTREPRENEUR
   - Start your own breeding facility
   - Supply butterflies to collectors and educational institutions
   - Expected income: 50,000 - 200,000/month

2. AGRICULTURAL TECHNICIAN
   - Work with research institutions
   - Develop new breeding techniques
   - Salary range: 25,000 - 45,000/month

3. EDUCATION SPECIALIST
   - Teach butterfly farming techniques
   - Conduct training programs
   - Consulting fees: 5,000 - 15,000/day

4. BIOTECHNOLOGY RESEARCHER
   - Study butterfly genetics and behavior
   - Develop conservation programs
   - Research positions: 35,000 - 70,000/month

Ready to start your journey? Enroll in our TESDA-certified programs!`);
            }, 1000);
        }

        function downloadTrainingGuide() {
            const guideContent = `BUTTERFLY PRODUCTION LEVEL II TRAINING GUIDE

COURSE OVERVIEW:
- Duration: 80 hours (6 weeks)
- Mode: Blended Learning (Online + Hands-on)
- Certificate: TESDA NC II

MODULES:
1. Butterfly Biology and Lifecycle Management
2. Advanced Breeding Techniques
3. Quality Control and Assessment
4. Disease Prevention and Treatment
5. Profit Optimization Strategies
6. Digital Record Keeping
7. Market Analysis and Sales
8. Sustainable Farming Practices

REQUIREMENTS:
- High School Diploma or equivalent
- Basic computer literacy
- Access to internet for online modules

CAREER PROSPECTS:
- Butterfly Farm Owner/Manager
- Agricultural Technician
- Research Assistant
- Training Specialist

For enrollment and scholarship information:
Visit: https://tesda.gov.ph
Email: info@tesda.gov.ph
Phone: (02) 8888-TESDA

穢 TESDA 2025 - Technical Education and Skills Development Authority`;

            const blob = new Blob([guideContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'TESDA-Butterfly-Production-Level-II-Guide.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showNotification('Training guide downloaded successfully!', 'success');
        }

        // AR Lifecycle Viewer variables
        let arViewer = null;

        // Initialize AR viewer
        async function initializeAR() {
            if (arViewer) {
                showNotification('AR viewer already initialized', 'info');
                return;
            }
            
            try {
                showNotification('Initializing AR viewer...', 'info');
                arViewer = new ARLifecycleViewer();
                await arViewer.initialize();
                
                const status = arViewer.getStatus();
                if (status.isInitialized) {
                    showNotification('AR viewer initialized successfully!', 'success');
                } else {
                    showNotification('AR viewer initialization failed', 'danger');
                }
            } catch (error) {
                console.error('Error initializing AR:', error);
                showNotification('Error initializing AR viewer', 'danger');
            }
        }

        // Update AR species
        function updateARSpecies() {
            const species = document.getElementById('ar-species').value;
            if (arViewer && species) {
                arViewer.updateSpecies(species);
                showNotification(`AR updated for ${species}`, 'success');
            }
        }

        // AR Lifecycle Viewer Class
        class ARLifecycleViewer {
            constructor() {
                this.isARSupported = false;
                this.currentStage = 'Egg';
                this.currentSpecies = 'Butterfly-Common Mormon';
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    console.log('Initializing AR Lifecycle Viewer...');
                    
                    if ('xr' in navigator) {
                        try {
                            const supported = await navigator.xr.isSessionSupported('immersive-ar');
                            this.isARSupported = supported;
                            
                            if (supported) {
                                console.log('AR is supported');
                                await this.setupAREnvironment();
                            } else {
                                console.log('AR not supported, falling back to 3D viewer');
                                await this.setup3DViewer();
                            }
                        } catch (error) {
                            console.log('WebXR check failed, using 3D viewer');
                            await this.setup3DViewer();
                        }
                    } else {
                        console.log('WebXR not available, using 3D viewer');
                        await this.setup3DViewer();
                    }
                    
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Error initializing AR viewer:', error);
                    return false;
                }
            }

            async setupAREnvironment() {
                const arButton = document.createElement('button');
                arButton.textContent = 'Start AR Experience';
                arButton.className = 'btn btn-primary ar-button';
                arButton.onclick = () => this.startARSession();
                
                const arContainer = document.getElementById('ar-container');
                if (arContainer) {
                    arContainer.appendChild(arButton);
                }
            }

            async setup3DViewer() {
                const viewerContainer = document.createElement('div');
                viewerContainer.id = 'lifecycle-3d-viewer';
                viewerContainer.style.cssText = `
                    width: 100%;
                    height: 400px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 15px;
                    position: relative;
                    overflow: hidden;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 20px 0;
                `;
                
                this.create3DLifecycleStages(viewerContainer);
                
                const arContainer = document.getElementById('ar-container');
                if (arContainer) {
                    arContainer.innerHTML = '';
                    arContainer.appendChild(viewerContainer);
                }
            }

            create3DLifecycleStages(container) {
                const stagesContainer = document.createElement('div');
                stagesContainer.style.cssText = `
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    width: 100%;
                    height: 100%;
                    padding: 20px;
                `;

                const stages = [
                    { name: 'Egg', icon: '', color: '#ffd700' },
                    { name: 'Larva', icon: '', color: '#32cd32' },
                    { name: 'Pupa', icon: '∴', color: '#8b4513' },
                    { name: 'Adult', icon: '', color: '#ff69b4' }
                ];

                stages.forEach((stage, index) => {
                    const stageElement = document.createElement('div');
                    stageElement.className = 'lifecycle-stage';
                    stageElement.style.cssText = `
                        text-align: center;
                        cursor: pointer;
                        transition: transform 0.3s ease;
                        padding: 15px;
                        border-radius: 10px;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        border: 2px solid rgba(255, 255, 255, 0.2);
                        min-width: 120px;
                    `;

                    stageElement.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 10px;">${stage.icon}</div>
                        <div style="color: white; font-weight: bold; font-size: 1.1rem;">${stage.name}</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-top: 5px;">
                            ${this.getStageDescription(stage.name)}
                        </div>
                    `;

                    stageElement.addEventListener('mouseenter', () => {
                        stageElement.style.transform = 'scale(1.1)';
                        stageElement.style.background = 'rgba(255, 255, 255, 0.2)';
                    });

                    stageElement.addEventListener('mouseleave', () => {
                        stageElement.style.transform = 'scale(1)';
                        stageElement.style.background = 'rgba(255, 255, 255, 0.1)';
                    });

                    stageElement.addEventListener('click', () => {
                        this.selectStage(stage.name);
                    });

                    stagesContainer.appendChild(stageElement);

                    if (index < stages.length - 1) {
                        const arrow = document.createElement('div');
                        arrow.innerHTML = '';
                        arrow.style.cssText = `
                            color: white;
                            font-size: 2rem;
                            font-weight: bold;
                            opacity: 0.7;
                        `;
                        stagesContainer.appendChild(arrow);
                    }
                });

                container.appendChild(stagesContainer);
            }

            getStageDescription(stage) {
                const descriptions = {
                    'Egg': 'Fertilized eggs laid on host plants',
                    'Larva': 'Caterpillar stage, rapid growth',
                    'Pupa': 'Chrysalis stage, metamorphosis',
                    'Adult': 'Mature butterfly, reproduction'
                };
                return descriptions[stage] || 'Stage description';
            }

            selectStage(stage) {
                this.currentStage = stage;
                
                const stages = document.querySelectorAll('.lifecycle-stage');
                stages.forEach(stageEl => {
                    stageEl.style.border = '2px solid rgba(255, 255, 255, 0.2)';
                });
                
                const currentStageEl = Array.from(stages).find(el => 
                    el.textContent.includes(stage)
                );
                if (currentStageEl) {
                    currentStageEl.style.border = '2px solid #00ff00';
                }

                this.showStageDetails(stage);
            }

            showStageDetails(stage) {
                const detailsContainer = document.getElementById('stage-details');
                if (!detailsContainer) return;

                const stageInfo = this.getDetailedStageInfo(stage);
                
                detailsContainer.innerHTML = `
                    <div class="stage-details-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h3 style="color: #2d3748; margin-bottom: 15px;">${stage} Stage</h3>
                        <div class="stage-info">
                            <div style="margin-bottom: 10px;">
                                <strong>Duration:</strong> ${stageInfo.duration}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Characteristics:</strong> ${stageInfo.characteristics}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Care Requirements:</strong> ${stageInfo.care}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Common Issues:</strong> ${stageInfo.issues}
                            </div>
                        </div>
                    </div>
                `;
            }

            getDetailedStageInfo(stage) {
                const stageData = {
                    'Egg': {
                        duration: '3-7 days',
                        characteristics: 'Small, round, attached to host plant leaves',
                        care: 'Maintain humidity, protect from predators',
                        issues: 'Desiccation, parasitism, predation'
                    },
                    'Larva': {
                        duration: '14-21 days',
                        characteristics: 'Caterpillar with multiple instars, feeding actively',
                        care: 'Fresh host plants, proper spacing, cleanliness',
                        issues: 'Disease, overcrowding, food shortage'
                    },
                    'Pupa': {
                        duration: '7-14 days',
                        characteristics: 'Chrysalis stage, internal restructuring',
                        care: 'Stable environment, minimal disturbance',
                        issues: 'Deformation, parasitism, premature emergence'
                    },
                    'Adult': {
                        duration: '2-4 weeks',
                        characteristics: 'Fully developed butterfly, ready for reproduction',
                        care: 'Nectar sources, mating space, egg-laying sites',
                        issues: 'Wing damage, poor mating success'
                    }
                };
                
                return stageData[stage] || {
                    duration: 'Variable',
                    characteristics: 'Stage characteristics',
                    care: 'Basic care requirements',
                    issues: 'Common problems'
                };
            }

            async startARSession() {
                try {
                    if (!this.isARSupported) {
                        throw new Error('AR not supported');
                    }
                    console.log('Starting AR session...');
                    this.showARInstructions();
                } catch (error) {
                    console.error('Failed to start AR session:', error);
                    showNotification('AR not available. Using 3D viewer instead.', 'warning');
                }
            }

            showARInstructions() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        <h3>AR Lifecycle Viewer</h3>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                            <p>Point your device at a flat surface to view the butterfly lifecycle in 3D!</p>
                            <div style="margin: 20px 0;">
                                <div> Move your device to explore different angles</div>
                                <div> Tap on lifecycle stages to learn more</div>
                                <div> Use gestures to interact with models</div>
                            </div>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn">
                                Start AR Experience
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            updateSpecies(species) {
                this.currentSpecies = species;
                console.log(`Updated AR viewer for species: ${species}`);
            }

            getStatus() {
                return {
                    isInitialized: this.isInitialized,
                    isARSupported: this.isARSupported,
                    currentStage: this.currentStage,
                    currentSpecies: this.currentSpecies
                };
            }
        }

        // Populate AR species dropdown
        function populateARSpeciesDropdown() {
            const arSpeciesSelect = document.getElementById('ar-species');
            if (!arSpeciesSelect) return;
            
            arSpeciesSelect.innerHTML = '<option value="">Choose species...</option>';
            
            if (speciesData && speciesData.length > 0) {
                speciesData.forEach(species => {
                    const option = document.createElement('option');
                    option.value = species.name;
                    option.textContent = species.name;
                    arSpeciesSelect.appendChild(option);
                });
            }
        }

        // Initialize the application when DOM is loaded (duplicate removed)

        // Update UI based on user role
        function updateUserInterface() {
            const header = document.querySelector('.header h1');
            if (currentUser && currentUser.username) {
                header.textContent = ` Welcome, ${currentUser.username}`;
            }
            
            // Hide navigation tabs based on user permissions
            const userRole = currentUser.role || 'user';
            const permissions = getRolePermissions(userRole);
            
            // CNN Classification tab
            if (!permissions.includes('classify_images') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'classification\')"]').style.display = 'none';
            }
            
            // Cage management tab
            if (!permissions.includes('create_batches') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'batches\')"]').style.display = 'none';
            }
            
            // Task management tab
            if (!permissions.includes('manage_tasks') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'tasks\')"]').style.display = 'none';
            }
            
            // Analytics tab
            if (!permissions.includes('view_analytics') && !permissions.includes('*')) {
                document.querySelector('[onclick="showTab(\'analytics\')"]').style.display = 'none';
            }
        }

    </script>
</body>
</html>